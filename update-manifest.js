#!/usr/bin/env node

/**
 * Update Assets Manifest Script
 * 
 * This script automatically scans the assets/mp3 and assets/midi folders
 * and generates the manifest.js file with all found audio files.
 * 
 * Usage:
 *   node update-manifest.js
 * 
 * The script will:
 * 1. Scan assets/mp3/ for .mp3 files
 * 2. Scan assets/midi/ for .mid and .midi files
 * 3. Generate friendly names from filenames
 * 4. Write the manifest.js file
 */

const fs = require('fs');
const path = require('path');

// Paths
const ASSETS_DIR = path.join(__dirname, 'assets');
const MP3_DIR = path.join(ASSETS_DIR, 'mp3');
const MIDI_DIR = path.join(ASSETS_DIR, 'midi');
const MANIFEST_PATH = path.join(ASSETS_DIR, 'manifest.js');

/**
 * Generate a friendly display name from a filename
 * @param {string} filename - The audio file name
 * @returns {string} - A friendly display name
 */
function generateFriendlyName(filename) {
    // Remove file extension
    let name = filename.replace(/\.(mp3|mid|midi)$/i, '');
    
    // Remove common YouTube ID patterns like [-xxxxx] or [_xxxxx] at the end
    name = name.replace(/[\[\(][-_][a-zA-Z0-9_-]+[\]\)]$/, '');
    
    // Remove track numbers like "01. " or "06. "
    name = name.replace(/^\d+\.\s*/, '');
    
    // Replace underscores with spaces
    name = name.replace(/_/g, ' ');
    
    // Trim whitespace
    name = name.trim();
    
    return name;
}

/**
 * Scan a directory for files with specific extensions
 * @param {string} dir - Directory path
 * @param {string[]} extensions - Array of file extensions to match
 * @returns {Array<{name: string, file: string}>} - Array of file entries
 */
function scanDirectory(dir, extensions) {
    // Check if directory exists
    if (!fs.existsSync(dir)) {
        console.warn(`‚ö†Ô∏è  Directory not found: ${dir}`);
        return [];
    }

    // Read directory contents
    const files = fs.readdirSync(dir);
    
    // Filter and map to manifest entries
    const entries = files
        .filter(file => {
            const ext = path.extname(file).toLowerCase();
            return extensions.includes(ext);
        })
        .sort() // Sort alphabetically
        .map(file => ({
            name: generateFriendlyName(file),
            file: file
        }));
    
    return entries;
}

/**
 * Generate the manifest.js file content
 * @param {Array} mp3Files - Array of MP3 file entries
 * @param {Array} midiFiles - Array of MIDI file entries
 * @returns {string} - The complete manifest.js file content
 */
function generateManifestContent(mp3Files, midiFiles) {
    const timestamp = new Date().toISOString();
    
    const content = `// Assets Manifest
// This file lists all available MP3 and MIDI files in the assets directory
// Auto-generated by update-manifest.js on ${timestamp}

// To update this file, run: node update-manifest.js

window.ASSETS_MANIFEST = {
    mp3: [
        // MP3 files in assets/mp3/ folder
${mp3Files.map(entry => `        { name: "${entry.name}", file: "${entry.file}" }`).join(',\n')}
    ],
    midi: [
        // MIDI files in assets/midi/ folder
${midiFiles.map(entry => `        { name: "${entry.name}", file: "${entry.file}" }`).join(',\n')}
    ]
};
`;
    
    return content;
}

/**
 * Main function
 */
function main() {
    console.log('üéµ Updating Assets Manifest...\n');
    
    // Scan directories
    console.log('üìÇ Scanning assets/mp3/...');
    const mp3Files = scanDirectory(MP3_DIR, ['.mp3']);
    console.log(`   Found ${mp3Files.length} MP3 file(s)`);
    
    console.log('üìÇ Scanning assets/midi/...');
    const midiFiles = scanDirectory(MIDI_DIR, ['.mid', '.midi']);
    console.log(`   Found ${midiFiles.length} MIDI file(s)`);
    
    // Generate manifest content
    console.log('\nüìù Generating manifest.js...');
    const manifestContent = generateManifestContent(mp3Files, midiFiles);
    
    // Write manifest file
    fs.writeFileSync(MANIFEST_PATH, manifestContent, 'utf8');
    console.log(`‚úÖ Manifest written to: ${MANIFEST_PATH}`);
    
    // Display summary
    console.log('\nüìã Summary:');
    console.log(`   Total MP3 files: ${mp3Files.length}`);
    console.log(`   Total MIDI files: ${midiFiles.length}`);
    
    if (mp3Files.length > 0) {
        console.log('\nüéµ MP3 Files:');
        mp3Files.forEach(entry => {
            console.log(`   - ${entry.name}`);
        });
    }
    
    if (midiFiles.length > 0) {
        console.log('\nüéπ MIDI Files:');
        midiFiles.forEach(entry => {
            console.log(`   - ${entry.name}`);
        });
    }
    
    console.log('\n‚ú® Done! Refresh your browser to see the updated file list.\n');
}

// Run the script
try {
    main();
} catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
}
